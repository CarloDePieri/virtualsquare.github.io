vpoll: synthesize virtual event for poll/select/ppoll/pselect/epoll
====

what
----
`vpoll` provides file descriptors that can be used in event waiting system calls (like `poll` or `select` and similar)
whose events can be generated as needed.

This feature needs a kernel support as it is not currently available a system call or another means to generate generic
events for a file descriptor.

Virtualsquare has developed two proposals for the kernel support:

* a patch to extend the functionalities of the `eventfd` system call
* a kernel module providing a device (`/dev/vpoll`)

The former currently requires a specific build of the Linux kernel, the latter can be added as a device module
on an existing kernel.

A user-level library (`libvpoll`) provides a general purpose interface to this new feature.
It detects if a `vpoll` kernel support is available and which one is present.
If no kernel support is available, `libvpoll` implements an emulated support providing a limited
set of events (`POLLIN`, `POLLOUT` and an incomplete `POLLHUP`).

why
----
When someone wants to write a library able to behave like a network stack or a device, they can easily implement their
own function as a replacement for counterpart's system call. This eases portability and compatibility.

Unfortunately this method cannot be applied to system calls like
`poll/select/ppoll/pselect/epoll`.  These system calls wait for one of a set of
file descriptors to become ready for I/O. In the scenario of a library implementing a network stack or a device
such system calls may need to refer at the same
time to some file descriptors created by *real* system calls like *open*,
*signalfd*...  and to other virtual file descriptors created by our own functions. While
it is possible to provide a partial problem specific support (e.g. using pipes or
socketpairs), a clean, complete general purpose solution was still missing (as far
as we have seen).

how
----
### The libvpoll library
This library:

- uses `eventfd/VPOLL` if supported by the kernel
- uses the vpoll device if available
- otherwise it implements an emulator (providing only `EPOLLIN`, `EPOLLOUT` and a non standard version of `EPOLLHUP/EPOLLRDHUP`, what can be done without a specific kernel support).

The API of libvpoll is clean and simple:

```
#define VPOLL_CTL_ADDEVENTS 1
#define VPOLL_CTL_DELEVENTS 2
#define VPOLL_CTL_SETEVENTS 3

int vpoll_create(uint32_t init_events, int flags);
int vpoll_ctl(int fd, int op, uint32_t events);
int vpoll_close(int fd);
```

- `vpoll_create` returns a file descriptor for vpoll
- `vpoll_ctl` adds, deletes or changes the currently active events on fd
- `vpoll_close` closes the vpoll file descriptor.

### direct access to vpoll as a virtual device (kernel module)
Once loaded the vpoll.ko kernel module, a new device (/dev/vpoll) will be created by udev.

A file descriptor for I/O event generation can be created with this statement:
```
fd = open("/dev/vpoll", O_RDWR | O_CLOEXEC);
```
which can be used in poll/select/epoll system calls.

The following tags:
```
#define VPOLL_IOC_MAGIC '^'
#define VPOLL_IO_ADDEVENTS _IO(VPOLL_IOC_MAGIC, 1)
#define VPOLL_IO_DELEVENTS _IO(VPOLL_IOC_MAGIC, 2)
#define VPOLL_IO_SETEVENTS _IO(VPOLL_IOC_MAGIC, 3)
```
can be used to add/delete or change the set of the current events.

Events can be generated by specific ioctl like `ioctl(fd, VPOLL_IO_ADDEVENTS, EPOLLIN | EPOLLPRI)` generates the events `EPOLLIN` and `EPOLLPRI`.

where
----
This support has been used in [picoxnet](https://github.com/virtualsquare/picoxnet).
The *Internet of Threads* library [libioth](https://github.com/virtualsquare/libioth) can provide a general support to user-level
implemented stacks because `vpoll` can be used in its plugin modules.

references:
----
More details are available on [Github](https://github.com/rd235/libvpoll-eventfd).

#### acknowledgement
thanks to Francesco Cerio who contributed a first draft of this page.
