We need to synthesize poll/select events
=====

# The problem

Many programs need to wait for events using poll/select etc.
Sometimes there is the need to wait for events also generated by
something else but file descriptors.

A common (but not general) workaround is to create a pipe, wait for a POLLIN
event on the reading end of the pipe and write a char on to unblock
the poll or select.

This method can generate only a POLLIN event.

There are situation in which a clean API needs a feature to mimic the behavior of
a real file descriptor.

It is the case of networking stacks implemented as libraries.

In LWIP [1] there are
more than 800 lines of code (1806-2687) to implement `lwip_poll` and `lwip_select`.
These functions can handle only the events coming from lwip sockets, it not
allowed to use a mix of real file descriptors and lwip sockets.

The same situation can be seen in PicoTCP [2] and mTCP [3].

# Proposal

It is possible to extend the `eventfd` system call to support the emulation of
poll events. Our libvpoll-eventfd project implements this proposal [4].

eventfd is able to create vpoll file descriptors where programmers can synthesize
all poll events.

* vpoll-eventfd uses the wait-for-fd-events support provided by the kernel so
all the user code currently included in the project to emulated poll or select


* all current (and future) system calls are suppported: poll, ppoll. select. pselect, epoll, ...

* it is possible to wait for events coming both from real file descriptors and from vpoll file 
descriptors handled by different libraries (e.g. write a program using lwip, picotcp and mtcp at
    the same time).

# Workaround

libvpoll includes a vpoll emulation based on socketpairs. Due to the limitation of socketpairs
only POLLIN and POLLOUT events are correctly managed. The emultaor provides a partial support 
for POLLHUP.


# Please

We'll submit the proposal to the LKML soon for a second time. We hope it will enter
the kernel mainstream in a short time.

# References

[1] [Lwip sockets.c code](http://git.savannah.nongnu.org/cgit/lwip.git/tree/src/api/sockets.c)

[2] [Picotcp sockets implementation](https://github.com/tass-belgium/picotcp-bsd/blob/master/pico_bsd_sockets.c)

[3] [Mtcp code](https://shader.kaist.edu/mtcp/).

[4] [libvpoll-eventfd](https://github.com/rd235/libvpoll-eventfd)
